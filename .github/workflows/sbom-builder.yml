# Reusable workflow for SBOM extraction and upload
name: SBOM Builder

on:
  workflow_call:
    inputs:
      app:
        description: 'App name (folder name under apps/)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (no upload to sbomify)'
        required: false
        type: boolean
        default: false
    secrets:
      SBOMIFY_TOKEN:
        required: false

env:
  YQ_VERSION: "v4.40.5"
  CRANE_VERSION: "v0.17.0"

jobs:
  build:
    name: ${{ inputs.app }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write      # Required for OIDC token
      contents: read       # Required to read repository
      attestations: write  # Required to write attestations
    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          # yq
          sudo curl -fsSL -o /usr/local/bin/yq \
            "https://github.com/mikefarah/yq/releases/download/${{ env.YQ_VERSION }}/yq_linux_amd64"
          sudo chmod +x /usr/local/bin/yq

          # crane
          CRANE_URL="https://github.com/google/go-containerregistry/releases/download"
          curl -fsSL "${CRANE_URL}/${{ env.CRANE_VERSION }}/go-containerregistry_Linux_x86_64.tar.gz" \
            | tar -xzf -
          sudo mv crane /usr/local/bin/

          # Source-specific tools
          SOURCE=$(yq -r '.source.type' "apps/${{ inputs.app }}/config.yaml")
          case "$SOURCE" in
            chainguard)
              curl -sLO "https://github.com/sigstore/cosign/releases/download/v2.2.2/cosign-linux-amd64"
              sudo install cosign-linux-amd64 /usr/local/bin/cosign
              ;;
          esac

      - name: Read config
        id: config
        run: |
          APP_DIR="apps/${{ inputs.app }}"
          CONFIG="${APP_DIR}/config.yaml"
          VERSION=$(yq -r '.version // ""' "$CONFIG" | tr -d '[:space:]')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "component_id=$(yq -r '.sbomify.component_id // ""' "$CONFIG")" >> $GITHUB_OUTPUT
          echo "component_name=$(yq -r '.sbomify.component_name // ""' "$CONFIG")" >> $GITHUB_OUTPUT
          echo "source_type=$(yq -r '.source.type // ""' "$CONFIG")" >> $GITHUB_OUTPUT
          echo "clone=$(yq -r '.source.clone // "false"' "$CONFIG")" >> $GITHUB_OUTPUT
          LOCKFILE_PATH=$(yq -r '.source.lockfile // ""' "$CONFIG")
          if [[ -n "$LOCKFILE_PATH" ]]; then
            echo "lockfile=$(basename "$LOCKFILE_PATH")" >> $GITHUB_OUTPUT
            # For cloned repos, lockfile is inside the repo/ directory
            CLONE=$(yq -r '.source.clone // "false"' "$CONFIG")
            if [[ "$CLONE" == "true" ]]; then
              echo "lockfile_path=repo/$LOCKFILE_PATH" >> $GITHUB_OUTPUT
            else
              echo "lockfile_path=$(basename "$LOCKFILE_PATH")" >> $GITHUB_OUTPUT
            fi
          else
            echo "lockfile=" >> $GITHUB_OUTPUT
            echo "lockfile_path=" >> $GITHUB_OUTPUT
          fi
          PRODUCT_ID=$(yq -r '.sbomify.product_id // ""' "$CONFIG")
          if [[ -n "$PRODUCT_ID" && -n "$VERSION" ]]; then
            echo "product_release=[\"${PRODUCT_ID}:${VERSION}\"]" >> $GITHUB_OUTPUT
          fi

      - name: Cache Maven dependencies
        if: steps.config.outputs.source_type == 'lockfile' && steps.config.outputs.clone == 'true'
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ inputs.app }}-${{ steps.config.outputs.version }}
          restore-keys: |
            maven-${{ inputs.app }}-
            maven-

      - name: Fetch SBOM or lockfile
        run: |
          ./scripts/fetch-sbom.sh "${{ inputs.app }}"
          if [[ "${{ steps.config.outputs.source_type }}" == "lockfile" ]]; then
            if [[ "${{ steps.config.outputs.clone }}" == "true" ]]; then
              ls -la repo/
            else
              ls -la "${{ steps.config.outputs.lockfile }}"
            fi
          else
            ls -la sbom.json
          fi

      - name: Upload input artifact
        if: always() && steps.config.outputs.source_type != 'lockfile'
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ inputs.app }}-${{ steps.config.outputs.version }}
          path: sbom.json

      - name: Upload lockfile artifact
        if: always() && steps.config.outputs.source_type == 'lockfile' && steps.config.outputs.clone != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: lockfile-${{ inputs.app }}-${{ steps.config.outputs.version }}
          path: ${{ steps.config.outputs.lockfile }}

      - name: Upload cloned repo artifact
        if: always() && steps.config.outputs.source_type == 'lockfile' && steps.config.outputs.clone == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: repo-${{ inputs.app }}-${{ steps.config.outputs.version }}
          path: repo/

      - name: Upload to sbomify (SBOM)
        if: steps.config.outputs.component_id != '' && steps.config.outputs.source_type != 'lockfile'
        uses: sbomify/github-action@master
        env:
          TOKEN: ${{ secrets.SBOMIFY_TOKEN }}
          COMPONENT_ID: ${{ steps.config.outputs.component_id }}
          COMPONENT_NAME: ${{ steps.config.outputs.component_name }}
          COMPONENT_VERSION: ${{ steps.config.outputs.version }}
          SBOM_FILE: sbom.json
          OUTPUT_FILE: sbom-output.json
          AUGMENT: true
          ENRICH: true
          UPLOAD: ${{ !inputs.dry_run }}
          PRODUCT_RELEASE: ${{ steps.config.outputs.product_release }}

      - name: Upload to sbomify (lockfile)
        if: steps.config.outputs.component_id != '' && steps.config.outputs.source_type == 'lockfile'
        uses: sbomify/github-action@master
        env:
          TOKEN: ${{ secrets.SBOMIFY_TOKEN }}
          COMPONENT_ID: ${{ steps.config.outputs.component_id }}
          COMPONENT_NAME: ${{ steps.config.outputs.component_name }}
          COMPONENT_VERSION: ${{ steps.config.outputs.version }}
          LOCK_FILE: ${{ steps.config.outputs.lockfile_path }}
          OUTPUT_FILE: sbom-output.json
          AUGMENT: true
          ENRICH: true
          UPLOAD: ${{ !inputs.dry_run }}
          PRODUCT_RELEASE: ${{ steps.config.outputs.product_release }}

      - name: Upload output artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sbom-output-${{ inputs.app }}-${{ steps.config.outputs.version }}
          path: sbom-output.json

      - name: Attest SBOM provenance
        if: steps.config.outputs.component_id != '' && !inputs.dry_run
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: sbom-output.json
